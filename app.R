library(shiny)
library(googlesheets4)
library(reactable)
library(shinydashboard)
library(shinyWidgets)
library(dplyr)
library(shinyjs)
library(tidyr)
library(lubridate)
library(stringr)

gs4_auth(cache = ".secrets", email = "leodonnun@gmail.com")
options(shiny.launch.browser = TRUE, shiny.autoreload = TRUE)

# Define UI for application that draws a histogram

ui <- dashboardPage(
  skin = "yellow",
  
  dashboardHeader(
    title = span(tags$img(src="logo.png", height="90%")),
    dropdownMenuOutput('dropdown_upmenu_ui')
  ),
  
  dashboardSidebar(
    sidebarMenu(
      menuItem("Painel", tabName = 'painel', icon = icon("chart-line")),
      menuItem("Registrar despesa", tabName = 'despesa', icon = icon("money-bill-transfer")),
      menuItem(
        "Cadastro", 
        tabName = 'cadastro', 
        icon = icon("table"),
        startExpanded = TRUE,
        menuSubItem('Usu치rio', tabName = 'usuario'),
        menuSubItem('Receita', tabName = 'receita'),
        menuSubItem('Categoria de despesa', tabName = 'gasto')
      )
    )
  ),
  
  dashboardBody(
    tags$head(
      tags$link(rel = "stylesheet", type = "text/css", href = "estilo.css"),
      tags$link(rel = "shortcut icon", href = "favicon.ico")
    ),
    shinyjs::useShinyjs(),
    
    tabItems(
      tabItem('painel', uiOutput('visualizacoes_ui')),
      tabItem('despesa', uiOutput('seletores_ui')),
      tabItem('cadastro')
    )
  )
)


# Define server logic required to draw a histogram
server <- function(input, output) {
  
  dados <- reactiveValues()
  url <- "https://docs.google.com/spreadsheets/d/1pD0WOSpT5kCzS_-17nsz0zFU9iHNeTQKs27H6Tg_a9w/edit?usp=sharing"
  sheet_despesa <- "pagamentos"
  sheet_usuario <- "usuario"
  sheet_categoria_gasto <- "categoria_gasto"
  
  
  # Render | dropdown_upmenu_ui ------------------------------------------
  output$dropdown_upmenu_ui <- renderUI({
    
    dados$usuario <- googlesheets4::read_sheet(url, sheet_usuario)
    dados$categoria_gasto <- googlesheets4::read_sheet(url, sheet_categoria_gasto)
    dados$pagamentos <- googlesheets4::read_sheet(url, sheet_despesa)
    
    vct_usuario <- NULL
    if (!is.null(dados$usuario)) {
      vct_usuario <- dados$usuario$id %>% setNames(dados$usuario$nome)
    }
    
    vct_mes <- 1:12 %>% setNames(stringr::str_to_title(lubridate::month(1:12, label = TRUE, abbr = FALSE)))
    mes_sel <- lubridate::month(Sys.Date()- months(1))
    vct_ano <- dados$pagamentos$ano_referencia %>% unique()
    ano_sel <- year(Sys.Date()- months(1))
    
    
    
    dropdownClass <- paste0("dropdown ", 'notifications', "-menu")
    
    tagList(
      tags$li(
        class = dropdownClass,
        style = 'height:51px;',
        tags$div(class = 'seletor_usuario',
                 selectInput(
                   'usuario_sel',
                   label = NULL,
                   choices = vct_usuario,
                   width = 'auto'
                 )
        ),
        tags$div(class = 'seletor_mes',
                 selectInput(
                   'mes_sel',
                   label = NULL,
                   choices = vct_mes,
                   width = 'auto',
                   selected = mes_sel
                 )
        ),
        tags$div(class = 'seletor_ano',
                 selectInput(
                   'ano_sel',
                   label = NULL,
                   choices = vct_ano,
                   width = 'auto',
                   selected = ano_sel
                 )
        )
      )
    )
    
    
  })
  
  
  # Observe | ano_sel
  observeEvent(input$ano_sel, {
    
    meses <-
      dados$pagamentos %>% 
      filter(ano_referencia == input$ano_sel) %>% 
      distinct(mes_referencia) %>% 
      pull(mes_referencia)
    
    vct_mes <- meses %>% setNames(str_to_title(lubridate::month(meses, label = TRUE, abbr = FALSE)))
    
    updateSelectInput(inputId = 'mes_sel', choices = vct_mes)
    
  })
  
  
  output$seletores_ui <- renderUI({
    #dados$usuario <- dados$usuario %>% mutate(id = as.numeric(id))
    
    fluidPage(
      uiOutput('seletores_sidebar_ui')
    )
    
  })
  
  
  output$seletores_sidebar_ui <- renderUI({
    
    dados_pagamentos <- !is.null(dados$pagamentos)
    dados_categorias <- !is.null(dados$categoria_gasto)
    dados_usuarios <- !is.null(dados$usuario)
    
    if (all(dados_pagamentos, dados_usuarios, dados_categorias)) {
      
      dados$categoria_gasto <- isolate(dados$categoria_gasto %>% arrange(nome))
      
      vct_categoria_gastos <- dados$categoria_gasto$id %>% setNames(dados$categoria_gasto$nome)
      
      
      tagList(
        column(4,
               selectInput('categoria_gasto_sel', "Categoria", choices = vct_categoria_gastos),
               currencyInput('valor', "Valor", value = 0, format = "Brazilian"),
               dateInput('data', label = 'Data'),
               actionButton('salvar_gasto', "Salvar", icon = icon("cloud-arrow-up"))
        ),
        column(8,
               reactableOutput('tabela_pagamentos')
        )
      )
      
    }
    
  })
  
  output$tabela_pagamentos <- renderReactable({
    dados$pagamentos %>% 
      reactable()
  })
  
  # Observe | salvar_gasto ----------------------------------------------
  observeEvent(input$salvar_gasto, {
    
    dados$pagamentos <-
      insert_nova_despesa(
        url = url, 
        sheet = sheet_despesa, 
        data = input$data,
        mes_referencia = input$mes_sel,
        ano_referencia = input$ano_sel, 
        categoria_gasto_id = input$categoria_gasto_sel,
        usuario_id = input$usuario_sel, 
        valor = input$valor 
      )
    
    
  })
  
  
  observeEvent(input$cadastrar_receita, {
    showModal(modalDialog(
      title = NULL,
      easyClose = FALSE,
      footer = list(modalButton('Calcelar'), actionButton('salvar_nova_receita', "Salvar")),
      size = 's',
      fluidPage(
        h3("Nova receita"),
        textInput('nome_nova_receita', NULL, placeholder = "Nome da receita"),
        currencyInput('valor_nova_receita', NULL, value = 0, format = "Brazilian"),
        checkboxInput('receita_mensal', "Receita mensal", value = TRUE),
        actionLink('gerenciar_receitas', "Ver dados completos", icon = icon("table"))
      )
    ))
  })
  
  
  observeEvent(input$nova_categoria_gasto, {
    showModal(modalDialog(
      title = NULL,
      easyClose = FALSE,
      footer = list(modalButton('Calcelar'), actionButton('salvar_nova_categoria', "Salvar")),
      size = 's',
      fluidPage(
        h3("Nova categoria de gasto"),
        textInput('nome_nova_categoria', NULL, placeholder = "Nome da categoria"),
        checkboxInput('gasto_fixo', "Gasto fixo", value = TRUE),
        checkboxInput('gasto_compartilhado', "Gasto compartilhado", value = TRUE),
        checkboxInput('gasto_exclusivo_usuario', "Gasto exclusivo do usu치rio", value = TRUE),
        actionLink('gerenciar_categorias', "Ver dados completos", icon = icon("table"))
        
      )
    ))
  })
  
  
  observeEvent(input$salvar_nova_categoria, {
    
    dados$categoria_gasto <- 
      insert_nova_categoria(
        nome = input$nome_nova_categoria,
        gasto_fixo = input$gasto_fixo, 
        compartilhado = input$gasto_compartilhado, 
        gasto_exclusivo_usuario = input$gasto_exclusivo_usuario, 
        usuario = input$usuario_sel
      )
    
    removeModal()
    
    shinyalert::shinyalert(title = "Nova categoria inserida", type = 'success')
    
  })
  
  observeEvent(input$gerenciar_categorias, {
    
    removeModal()
    
    showModal(modalDialog(
      title = NULL,
      easyClose = FALSE,
      footer = list(
        modalButton('Fechar'), 
        disabled(actionButton('deletar_categoria', "Deletar")),
        disabled(actionButton('editar_categoria', "Editar"))
      ),
      size = 'l',
      tagList(
        reactableOutput('tabela_categorias')
      )
    ))
    
  })
  
  output$tabela_categorias <- renderReactable({
    
    dados$categoria_gasto %>% 
      mutate(dplyr::across(.cols = c(gasto_fixo, compartilhado , gasto_exclusivo_usuario), ~if_else(.x, "\U0002713", "\U0002717"))) %>% 
      dplyr::left_join(dados$usuario %>% select(usuario_id = id, nome_usuario = nome)) %>% 
      reactable(
        onClick = 'select',
        selection = "single",
        theme = reactableTheme(
          rowSelectedStyle = list(backgroundColor = "#eee", boxShadow = "inset 2px 0 0 0 #ffa62d"),
          searchInputStyle = list(`align-self` = 'flex-start')
        ),
        searchable = TRUE,
        pagination = F,
        highlight = TRUE, 
        height = 300,
        outlined  =  TRUE,
        rowStyle = list(cursor = "pointer"),
        wrap = FALSE,
        columns = list(
          .selection = colDef(show = FALSE),
          id = colDef(show = FALSE),
          nome = colDef(name = "Nome"),
          gasto_fixo = colDef(name = "Gasto fixo", align = 'center'),
          compartilhado = colDef(name = "Compartilhado", align = 'center'),
          gasto_exclusivo_usuario = colDef(name = "Usu치rio", align = 'center'),
          nome_usuario = colDef(name = "Nome do usu치rio"),
          usuario_id = colDef(show = FALSE)
        )
      )
  })
  
  observeEvent(input$tabela_categorias__reactable__selected, ignoreNULL = FALSE, {
    
    if (!is.null(input$tabela_categorias__reactable__selected)){
      
      enable('deletar_categoria')
      enable('editar_categoria')
      
    } else {
      
      disable('deletar_categoria')
      disable('editar_categoria')
      
    }
    
  })
  
  
  observeEvent(input$deletar_categoria, {
    
    aux <-
      dados$categoria_gasto %>% 
      slice(-input$tabela_categorias__reactable__selected)
    
    url <- "https://docs.google.com/spreadsheets/d/1pD0WOSpT5kCzS_-17nsz0zFU9iHNeTQKs27H6Tg_a9w/edit?usp=sharing"
    sheet <- 'categoria_gasto'
    
    googlesheets4::write_sheet(aux, ss = url, sheet = sheet)
    
    dados$categoria_gasto <- aux
    
  })
  
  
  # Output | visualizacoes_ui ---------------------------------------------
  output$visualizacoes_ui <- renderUI({
    
    tagList(
      fluidRow(
        valueBoxOutput('renda_total'),
        valueBoxOutput('gasto_total')
      ),
      column(
        width = 4,
        reactable::reactableOutput('tabela_gastos')
      ),
      column(8)
    )
    
  })
  
  
  # Render | tabela_gastos -------------------------------------------------
  output$tabela_gastos <- renderReactable({
    
    if (!is.null(dados$pagamentos)) {
      
      reais = colFormat(currency = "BRL", separators = TRUE, locales = "pt-BR")
      
      dados$usuario %>% 
        select(
          usuario_id = id, 
          nome_usuario = nome) %>% 
        left_join(
          dados$pagamentos,
          by = "usuario_id"
        ) %>% 
        left_join(
          dados$categoria_gasto %>% 
            select(
              categoria_gasto_id = id, 
              nome_categoria = nome, 
              usuario_id, 
              usuario_categoria_id = usuario_id,
              compartilhado),
          by = "categoria_gasto_id"
        ) %>% 
        group_by(nome_usuario) %>% 
        summarise(
          "Gasto total" = sum(valor), 
          "Gasto compartilhado" = sum(valor[compartilhado], na.rm = TRUE),
          "Gasto particular" = sum(valor[!compartilhado], na.rm = TRUE)
        ) %>% 
        ungroup() %>% 
        tidyr::pivot_longer(cols = -nome_usuario) %>% 
        mutate(value = if_else(is.na(value), 0, value)) %>% 
        tidyr::pivot_wider(names_from = nome_usuario, values_from = value) %>%
        reactable::reactable(
          pagination = F,
          highlight = TRUE,
          outlined  =  TRUE,
          rowStyle = list(cursor = "pointer"),
          defaultColDef = colDef(
            align = "center",
            headerStyle = list(background = "#f7f7f8")
          ),
          wrap = FALSE,
          columns = list(
            name = colDef(name = "Resumo dos gastos", minWidth = 150, maxWidth = 500),
            Leonardo = colDef(format = reais),
            Taise = colDef(format = reais)
          )
        )
      
    }
    
  })
  
  # Render | caixas de valor -------------------------------------------------
  output$renda_total <- renderValueBox({
    valueBox(value = reais(10000), subtitle = "Renda total", icon = icon("sack-dollar"))
  })
  
  output$gasto_total <- renderValueBox({
    
    if (!is.null(dados$pagamentos)) {
      
      valor <- dados$pagamentos$valor %>% sum(na.rm = TRUE)
      valueBox(value = reais(valor), subtitle = "Gasto total", icon = icon("money-bill-transfer"))
      
    }
    
  })
  
  
  
  # Fun칞칫es -----------------------------------------------------------------
  insert_nova_categoria <- function(nome, gasto_fixo, compartilhado, gasto_exclusivo_usuario, usuario) {
    
    url <- "https://docs.google.com/spreadsheets/d/1pD0WOSpT5kCzS_-17nsz0zFU9iHNeTQKs27H6Tg_a9w/edit?usp=sharing"
    sheet <- 'categoria_gasto'
    
    aux <- googlesheets4::read_sheet(
      ss = url,
      sheet = sheet)
    
    id <- (aux$id %>% max()) + 1
    
    dados <- 
      data.frame(
        id = id,
        nome = nome, 
        gasto_fixo = gasto_fixo, 
        compartilhado = compartilhado, 
        gasto_exclusivo_usuario = gasto_exclusivo_usuario, 
        usuario_id = as.numeric(usuario))
    
    googlesheets4::sheet_append(data = dados, ss = url, sheet = sheet)
    
    aux <- aux %>% dplyr::add_row(dados)
    
    return(aux)
    
  }
  
  insert_nova_despesa <- function(url, sheet, data, mes_referencia, ano_referencia, categoria_gasto_id, usuario_id, valor) {
    
    aux <- googlesheets4::read_sheet(
      ss = url,
      sheet = sheet)
    
    id <- (aux$id %>% max()) + 1
    
    dados <-
      data.frame(
        id	= id,
        data	= data,
        mes_referencia	= as.numeric(mes_referencia),
        ano_referencia = as.numeric(ano_referencia),	
        categoria_gasto_id = as.numeric(categoria_gasto_id),	
        usuario_id = as.numeric(usuario_id),	
        valor = as.numeric(valor)
      )
    
    googlesheets4::sheet_append(data = dados, ss = url, sheet = sheet)
    
    aux <- aux %>% dplyr::add_row(dados)
    
    return(aux)
    
  }
  
  
  reais <- scales::number_format(accuracy = 0.01,prefix = 'R$', big.mark = ".", decimal.mark = ",")
  
  
}

# Run the application 
shinyApp(ui = ui, server = server)
